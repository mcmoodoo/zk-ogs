# Justfile for RPS Hook Deployment and Management
# Usage: just <command> [arguments]

# Default RPC URL (can be overridden with RPC_URL env var)
default-rpc-url := "http://localhost:8545"

# Default account name (can be overridden with ACCOUNT env var)
default-account := "default"

# Default private key for local Anvil (can be overridden with PRIVATE_KEY env var)
# This is Anvil's default first account private key
default-private-key := "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

# Default sender address (can be overridden with SENDER env var)
# Note: Leave empty to not use --sender flag

# Hook address storage file
hook-address-file := ".hook_address"

# V4 infrastructure address files
pool-manager-file := ".pool_manager_address"
position-manager-file := ".position_manager_address"
router-file := ".router_address"

# ============================================================================
# Setup & Configuration
# ============================================================================

# Show available commands
default:
    @just --list

# Set hook address from environment or file
set-hook-address HOOK_ADDRESS:
    #!/usr/bin/env bash
    echo "{{HOOK_ADDRESS}}" > {{hook-address-file}}
    export HOOK_ADDRESS="{{HOOK_ADDRESS}}"
    echo "Hook address set to: {{HOOK_ADDRESS}}"
    echo "You can now run: export HOOK_ADDRESS={{HOOK_ADDRESS}}"

# Get hook address from file (if exists)
get-hook-address:
    #!/usr/bin/env bash
    if [ -f {{hook-address-file}} ]; then
        cat {{hook-address-file}}
    else
        echo "No hook address found. Run 'just deploy-hook' first."
        exit 1
    fi

# ============================================================================
# Deployment Commands
# ============================================================================

# Deploy test tokens for local development
# Usage: just deploy-tokens [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...]
# Note: For local Anvil, PRIVATE_KEY defaults to Anvil's first account key if not provided
deploy-tokens RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80":
    #!/usr/bin/env bash
    set -e
    
    # Check if tokens are already deployed
    if [ -f .token0_address ] && [ -f .token1_address ]; then
        TOKEN0=$(cat .token0_address)
        TOKEN1=$(cat .token1_address)
        # Check if contracts have code at these addresses
        CODE0=$(cast code "$TOKEN0" --rpc-url {{RPC_URL}} 2>/dev/null || echo "")
        CODE1=$(cast code "$TOKEN1" --rpc-url {{RPC_URL}} 2>/dev/null || echo "")
        if [ -n "$CODE0" ] && [ -n "$CODE1" ] && [ "$CODE0" != "0x" ] && [ "$CODE1" != "0x" ]; then
            echo "✓ Tokens already deployed:"
            echo "  Token0: $TOKEN0"
            echo "  Token1: $TOKEN1"
            echo "Skipping token deployment."
            exit 0
        fi
    fi
    
    # Use the provided private key (defaults to Anvil's first account)
    # Justfile expands {{PRIVATE_KEY}} but may include quotes, so clean it
    PK_VAL="{{PRIVATE_KEY}}"
    PK_VAL=$(echo "$PK_VAL" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//" | xargs)
    
    echo "Deploying test tokens..."
    # Capture the full output including broadcast results
    OUTPUT=$(forge script script/00_DeployTokens.s.sol \
        --rpc-url {{RPC_URL}} \
        --private-key "$PK_VAL" \
        --broadcast 2>&1 || true)
    
    # Extract token addresses from the broadcast output
    # The addresses are in the "Deployed Token0 at:" and "Deployed Token1 at:" log lines
    TOKEN0=$(echo "$OUTPUT" | grep -oP 'Deployed Token0 at: \K0x[a-fA-F0-9]{40}' || echo "")
    TOKEN1=$(echo "$OUTPUT" | grep -oP 'Deployed Token1 at: \K0x[a-fA-F0-9]{40}' || echo "")
    
    # If not found, try alternative patterns from the logs section
    if [ -z "$TOKEN0" ] || [ -z "$TOKEN1" ]; then
        # Look in the logs section
        LOGS_SECTION=$(echo "$OUTPUT" | sed -n '/== Logs ==/,/==/p' || echo "")
        if [ -n "$LOGS_SECTION" ]; then
            [ -z "$TOKEN0" ] && TOKEN0=$(echo "$LOGS_SECTION" | grep -i "token0" | grep -oP '0x[a-fA-F0-9]{40}' | head -1 || echo "")
            [ -z "$TOKEN1" ] && TOKEN1=$(echo "$LOGS_SECTION" | grep -i "token1" | grep -oP '0x[a-fA-F0-9]{40}' | tail -1 || echo "")
        fi
    fi
    
    if [ -n "$TOKEN0" ] && [ -n "$TOKEN1" ]; then
        echo "$TOKEN0" > .token0_address
        echo "$TOKEN1" > .token1_address
        echo ""
        echo "✓ Token0 deployed at: $TOKEN0"
        echo "✓ Token1 deployed at: $TOKEN1"
        echo ""
        echo "Note: Update BaseScript.sol defaults or set TOKEN0_ADDRESS and TOKEN1_ADDRESS env vars"
    fi

# Deploy the RPS Hook contract
# Usage: just deploy-hook [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...]
# Note: PRIVATE_KEY defaults to Anvil's first account key if not provided
deploy-hook RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" ACCOUNT='' SENDER='':
    #!/usr/bin/env bash
    set -e
    
    # Check if hook is already deployed
    if [ -f {{hook-address-file}} ]; then
        HOOK_ADDR=$(cat {{hook-address-file}})
        # Check if contract has code at this address
        CODE=$(cast code "$HOOK_ADDR" --rpc-url {{RPC_URL}} 2>/dev/null || echo "")
        if [ -n "$CODE" ] && [ "$CODE" != "0x" ]; then
            echo "✓ Hook already deployed at: $HOOK_ADDR"
            echo "Skipping hook deployment."
            exit 0
        fi
    fi
    
    RPC_ARG="--rpc-url {{RPC_URL}}"
    ACCOUNT_ARG=""
    SENDER_ARG=""
    
    # Only use --account if explicitly provided and not empty
    ACCOUNT_VAL="{{ACCOUNT}}"
    if [ -n "$ACCOUNT_VAL" ] && [ "$ACCOUNT_VAL" != "" ]; then
        ACCOUNT_ARG="--account"
        ACCOUNT_VALUE="$ACCOUNT_VAL"
    else
        ACCOUNT_ARG=""
        ACCOUNT_VALUE=""
    fi
    
    SENDER_VAL="{{SENDER}}"
    if [ -n "$SENDER_VAL" ] && [ "$SENDER_VAL" != "''" ] && [ "$SENDER_VAL" != "" ]; then
        SENDER_ARG="--sender"
        SENDER_VALUE="$SENDER_VAL"
    else
        SENDER_ARG=""
        SENDER_VALUE=""
    fi
    
    # Use private key for local Anvil, or account for other networks
    PRIVATE_KEY_VAL="{{PRIVATE_KEY}}"
    PK_VAL=$(echo "$PRIVATE_KEY_VAL" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//" | xargs)
    if [ -n "$PK_VAL" ] && [ "$PK_VAL" != "" ]; then
        PRIVATE_KEY_ARG="--private-key"
        PRIVATE_KEY_VALUE="$PK_VAL"
    else
        PRIVATE_KEY_ARG=""
        PRIVATE_KEY_VALUE=""
    fi
    
    echo "Deploying RPS Hook..."
    
    # Load PoolManager address if available
    if [ -f {{pool-manager-file}} ]; then
        POOL_MGR=$(cat {{pool-manager-file}})
        export POOL_MANAGER_ADDRESS=$POOL_MGR
    fi
    
    # Build and run the deployment command, capturing output
    PK_VAL=$(echo "$PRIVATE_KEY_VAL" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//" | xargs)
    
    # Build command array
    CMD_ARGS=("script/00_DeployHook.s.sol" $RPC_ARG)
    if [ -n "$PK_VAL" ] && [ "$PK_VAL" != "" ]; then
        CMD_ARGS+=("--private-key" "$PK_VAL")
    fi
    [ -n "$ACCOUNT_ARG" ] && [ -n "$ACCOUNT_VALUE" ] && CMD_ARGS+=($ACCOUNT_ARG "$ACCOUNT_VALUE")
    [ -n "$SENDER_ARG" ] && [ -n "$SENDER_VALUE" ] && CMD_ARGS+=($SENDER_ARG "$SENDER_VALUE")
    CMD_ARGS+=(--broadcast)
    
    # Run deployment and capture output
    OUTPUT=$(forge script "${CMD_ARGS[@]}" 2>&1 || true)
    echo "$OUTPUT"
    
    # Extract hook address from the output
    # Pattern 1: "Deployed RPSHook at: 0x..."
    HOOK_ADDR=$(echo "$OUTPUT" | grep -oP 'Deployed RPSHook at: \K0x[a-fA-F0-9]{40}' || echo "")
    
    # Pattern 2: Look in the logs section
    if [ -z "$HOOK_ADDR" ]; then
        LOGS_SECTION=$(echo "$OUTPUT" | sed -n '/== Logs ==/,/==/p' || echo "")
        if [ -n "$LOGS_SECTION" ]; then
            HOOK_ADDR=$(echo "$LOGS_SECTION" | grep -i "rpshook" | grep -oP '0x[a-fA-F0-9]{40}' | head -1 || echo "")
        fi
    fi
    
    # Pattern 3: Look for any line with "RPSHook" and an address
    if [ -z "$HOOK_ADDR" ]; then
        HOOK_ADDR=$(echo "$OUTPUT" | grep -i "rpshook" | grep -oP '0x[a-fA-F0-9]{40}' | head -1 || echo "")
    fi
    
    if [ -n "$HOOK_ADDR" ]; then
        echo "$HOOK_ADDR" > {{hook-address-file}}
        echo ""
        echo "✓ Hook deployed at: $HOOK_ADDR"
        echo "✓ Hook address saved to {{hook-address-file}}"
        echo ""
        echo "To use in subsequent commands, run:"
        echo "  export HOOK_ADDRESS=$HOOK_ADDR"
        echo "Or use: just set-hook-address $HOOK_ADDR"
    else
        echo "⚠ Could not extract hook address automatically."
        echo "Please check the output above and set HOOK_ADDRESS manually."
    fi

# Deploy V4 artifacts locally (for Anvil)
# Usage: just deploy-v4 [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...]
deploy-v4 RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" ACCOUNT='' SENDER='':
    #!/usr/bin/env bash
    set -e
    
    # Check if V4 contracts are already deployed
    # V4 contracts use CREATE2, so addresses are deterministic
    # Known deterministic addresses for local Anvil (chainId 31337):
    # PoolManager: 0x0D9BAf34817Fccd3b3068768E5d20542B66424A5
    # PositionManager: 0x90aAE8e3C8dF1d226431D0C2C7feAaa775fAF86C
    # Router: 0x2279B7A0a67DB372996a5FaB50D91eAA73d2eBe6
    
    # First check if we have saved addresses
    if [ -f {{pool-manager-file}} ] && [ -f {{position-manager-file}} ] && [ -f {{router-file}} ]; then
        POOL_MGR=$(cat {{pool-manager-file}})
        POS_MGR=$(cat {{position-manager-file}})
        ROUTER=$(cat {{router-file}})
    else
        # Use known deterministic addresses for local Anvil
        POOL_MGR="0x0D9BAf34817Fccd3b3068768E5d20542B66424A5"
        POS_MGR="0x90aAE8e3C8dF1d226431D0C2C7feAaa775fAF86C"
        ROUTER="0x2279B7A0a67DB372996a5FaB50D91eAA73d2eBe6"
    fi
    
    # Check if contracts have code at these addresses
    CODE_PM=$(cast code "$POOL_MGR" --rpc-url {{RPC_URL}} 2>/dev/null || echo "")
    CODE_POS=$(cast code "$POS_MGR" --rpc-url {{RPC_URL}} 2>/dev/null || echo "")
    CODE_RTR=$(cast code "$ROUTER" --rpc-url {{RPC_URL}} 2>/dev/null || echo "")
    if [ -n "$CODE_PM" ] && [ -n "$CODE_POS" ] && [ -n "$CODE_RTR" ] && \
       [ "$CODE_PM" != "0x" ] && [ "$CODE_POS" != "0x" ] && [ "$CODE_RTR" != "0x" ]; then
        # Save addresses to files if not already saved
        [ ! -f {{pool-manager-file}} ] && echo "$POOL_MGR" > {{pool-manager-file}}
        [ ! -f {{position-manager-file}} ] && echo "$POS_MGR" > {{position-manager-file}}
        [ ! -f {{router-file}} ] && echo "$ROUTER" > {{router-file}}
        echo "✓ V4 contracts already deployed:"
        echo "  PoolManager: $POOL_MGR"
        echo "  PositionManager: $POS_MGR"
        echo "  Router: $ROUTER"
        echo "Skipping V4 deployment."
        exit 0
    fi
    
    RPC_ARG="--rpc-url {{RPC_URL}}"
    PRIVATE_KEY_ARG=""
    ACCOUNT_ARG=""
    SENDER_ARG=""
    
    # Use private key for local Anvil
    PRIVATE_KEY_VAL="{{PRIVATE_KEY}}"
    if [ -n "$PRIVATE_KEY_VAL" ] && [ "$PRIVATE_KEY_VAL" != "" ]; then
        PRIVATE_KEY_ARG="--private-key"
        PRIVATE_KEY_VALUE="$PRIVATE_KEY_VAL"
    else
        PRIVATE_KEY_ARG=""
        PRIVATE_KEY_VALUE=""
    fi
    
    # Only use --account if explicitly provided
    ACCOUNT_VAL="{{ACCOUNT}}"
    if [ -n "$ACCOUNT_VAL" ] && [ "$ACCOUNT_VAL" != "default" ] && [ "$ACCOUNT_VAL" != "" ]; then
        ACCOUNT_ARG="--account"
        ACCOUNT_VALUE="$ACCOUNT_VAL"
    else
        ACCOUNT_ARG=""
        ACCOUNT_VALUE=""
    fi
    
    SENDER_VAL="{{SENDER}}"
    if [ -n "$SENDER_VAL" ] && [ "$SENDER_VAL" != "''" ] && [ "$SENDER_VAL" != "" ]; then
        SENDER_ARG="--sender"
        SENDER_VALUE="$SENDER_VAL"
    else
        SENDER_ARG=""
        SENDER_VALUE=""
    fi
    
    echo "Deploying V4 artifacts to local network..."
    # Build command array to avoid empty argument issues
    CMD_ARGS=("script/testing/00_DeployV4.s.sol" $RPC_ARG)
    [ -n "$PRIVATE_KEY_ARG" ] && CMD_ARGS+=($PRIVATE_KEY_ARG "$PRIVATE_KEY_VALUE")
    [ -n "$ACCOUNT_ARG" ] && CMD_ARGS+=($ACCOUNT_ARG "$ACCOUNT_VALUE")
    [ -n "$SENDER_ARG" ] && CMD_ARGS+=($SENDER_ARG "$SENDER_VALUE")
    CMD_ARGS+=(--broadcast)
    
    forge script "${CMD_ARGS[@]}"
    
    # Extract and save addresses from output
    echo ""
    echo "Extracting deployed addresses..."
    if [ -n "$PRIVATE_KEY_ARG" ]; then
        OUTPUT=$(forge script script/testing/00_DeployV4.s.sol $RPC_ARG $PRIVATE_KEY_ARG "$PRIVATE_KEY_VALUE" 2>&1 || true)
    else
        OUTPUT=$(forge script script/testing/00_DeployV4.s.sol $RPC_ARG 2>&1 || true)
    fi
    
    POOL_MGR=$(echo "$OUTPUT" | grep -oP 'Deployed V4PoolManager at: \K0x[a-fA-F0-9]{40}' || echo "")
    POS_MGR=$(echo "$OUTPUT" | grep -oP 'Deployed V4PositionManager at: \K0x[a-fA-F0-9]{40}' || echo "")
    ROUTER=$(echo "$OUTPUT" | grep -oP 'Deployed V4SwapRouter at: \K0x[a-fA-F0-9]{40}' || echo "")
    
    if [ -n "$POOL_MGR" ]; then
        echo "$POOL_MGR" > {{pool-manager-file}}
        echo "✓ Saved PoolManager address: $POOL_MGR"
    fi
    if [ -n "$POS_MGR" ]; then
        echo "$POS_MGR" > {{position-manager-file}}
        echo "✓ Saved PositionManager address: $POS_MGR"
    fi
    if [ -n "$ROUTER" ]; then
        echo "$ROUTER" > {{router-file}}
        echo "✓ Saved Router address: $ROUTER"
    fi

# ============================================================================
# Pool Management Commands
# ============================================================================

# Create a new pool and add initial liquidity
# Usage: just create-pool [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...]
# Note: HOOK_ADDRESS can be provided via environment variable or will be loaded from .hook_address file
create-pool RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" ACCOUNT='' SENDER='':
    #!/usr/bin/env bash
    set -e
    
    # Load hook address from environment variable or file
    if [ -z "$HOOK_ADDRESS" ] && [ -f {{hook-address-file}} ]; then
        HOOK_ADDRESS=$(cat {{hook-address-file}})
        export HOOK_ADDRESS
        echo "Using hook address from file: $HOOK_ADDRESS"
    elif [ -z "$HOOK_ADDRESS" ]; then
        echo "Error: HOOK_ADDRESS not set and not found in {{hook-address-file}}"
        echo "Please set HOOK_ADDRESS environment variable or run 'just deploy-hook' first"
        exit 1
    else
        export HOOK_ADDRESS
        echo "Using hook address from environment: $HOOK_ADDRESS"
    fi
    
    # Load token addresses from files if available (from deploy-tokens)
    if [ -f .token0_address ] && [ -f .token1_address ]; then
        TOKEN0=$(cat .token0_address)
        TOKEN1=$(cat .token1_address)
        export TOKEN0_ADDRESS="$TOKEN0"
        export TOKEN1_ADDRESS="$TOKEN1"
        echo "Using deployed tokens:"
        echo "  TOKEN0_ADDRESS=$TOKEN0"
        echo "  TOKEN1_ADDRESS=$TOKEN1"
    fi
    
    RPC_ARG="--rpc-url {{RPC_URL}}"
    PRIVATE_KEY_ARG=""
    ACCOUNT_ARG=""
    SENDER_ARG=""
    
    # Use private key for local Anvil, or account for other networks
    PRIVATE_KEY_VAL="{{PRIVATE_KEY}}"
    PK_VAL=$(echo "$PRIVATE_KEY_VAL" | sed -e 's/^"//' -e 's/"$//' -e "s/^'//" -e "s/'$//" | xargs)
    if [ -n "$PK_VAL" ] && [ "$PK_VAL" != "" ]; then
        PRIVATE_KEY_ARG="--private-key"
        PRIVATE_KEY_VALUE="$PK_VAL"
    else
        PRIVATE_KEY_ARG=""
        PRIVATE_KEY_VALUE=""
    fi
    
    # Only use --account if explicitly provided and not "default"
    ACCOUNT_VAL="{{ACCOUNT}}"
    if [ -n "$ACCOUNT_VAL" ] && [ "$ACCOUNT_VAL" != "default" ] && [ "$ACCOUNT_VAL" != "" ]; then
        ACCOUNT_ARG="--account"
        ACCOUNT_VALUE="$ACCOUNT_VAL"
    else
        ACCOUNT_ARG=""
        ACCOUNT_VALUE=""
    fi
    
    SENDER_VAL="{{SENDER}}"
    if [ -n "$SENDER_VAL" ] && [ "$SENDER_VAL" != "''" ] && [ "$SENDER_VAL" != "" ]; then
        SENDER_ARG="--sender"
        SENDER_VALUE="$SENDER_VAL"
    else
        SENDER_ARG=""
        SENDER_VALUE=""
    fi
    
    # Load V4 infrastructure addresses if available
    if [ -f {{pool-manager-file}} ]; then
        POOL_MGR=$(cat {{pool-manager-file}})
        export POOL_MANAGER_ADDRESS=$POOL_MGR
    fi
    if [ -f {{position-manager-file}} ]; then
        POS_MGR=$(cat {{position-manager-file}})
        export POSITION_MANAGER_ADDRESS=$POS_MGR
    fi
    if [ -f {{router-file}} ]; then
        ROUTER=$(cat {{router-file}})
        export ROUTER_ADDRESS=$ROUTER
    fi
    
    echo "Creating pool with hook: $HOOK_ADDRESS"
    # Build command array to avoid empty argument issues
    CMD_ARGS=("script/01_CreatePoolAndAddLiquidity.s.sol" "--rpc-url" "{{RPC_URL}}")
    [ -n "$PRIVATE_KEY_ARG" ] && CMD_ARGS+=($PRIVATE_KEY_ARG "$PRIVATE_KEY_VALUE")
    [ -n "$ACCOUNT_ARG" ] && [ -n "$ACCOUNT_VALUE" ] && CMD_ARGS+=($ACCOUNT_ARG "$ACCOUNT_VALUE")
    [ -n "$SENDER_ARG" ] && [ -n "$SENDER_VALUE" ] && CMD_ARGS+=($SENDER_ARG "$SENDER_VALUE")
    CMD_ARGS+=(--broadcast)
    
    forge script "${CMD_ARGS[@]}"

# Add liquidity to an existing pool
# Usage: just add-liquidity [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...] [HOOK_ADDRESS=]
add-liquidity RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" ACCOUNT='' SENDER='' HOOK_ADDRESS="":
    #!/usr/bin/env bash
    set -e
    
    # Load hook address from file if not provided
    if [ -z "{{HOOK_ADDRESS}}" ] && [ -f {{hook-address-file}} ]; then
        HOOK_ADDRESS=$(cat {{hook-address-file}})
        echo "Using hook address from file: $HOOK_ADDRESS"
    elif [ -z "{{HOOK_ADDRESS}}" ]; then
        echo "Error: HOOK_ADDRESS not set and not found in {{hook-address-file}}"
        echo "Please set HOOK_ADDRESS environment variable or run 'just deploy-hook' first"
        exit 1
    else
        HOOK_ADDRESS="{{HOOK_ADDRESS}}"
    fi
    
    RPC_ARG="--rpc-url {{RPC_URL}}"
    PRIVATE_KEY_ARG=""
    ACCOUNT_ARG=""
    SENDER_ARG=""
    
    # Use private key for local Anvil, or account for other networks
    PRIVATE_KEY_VAL="{{PRIVATE_KEY}}"
    if [ -n "$PRIVATE_KEY_VAL" ] && [ "$PRIVATE_KEY_VAL" != "" ]; then
        PRIVATE_KEY_ARG="--private-key $PRIVATE_KEY_VAL"
    fi
    
    # Only use --account if explicitly provided and not "default"
    if [ -n "{{ACCOUNT}}" ] && [ "{{ACCOUNT}}" != "default" ] && [ "{{ACCOUNT}}" != "" ]; then
        ACCOUNT_ARG="--account {{ACCOUNT}}"
    fi
    
    if [ -n "{{SENDER}}" ] && [ "{{SENDER}}" != "''" ] && [ "{{SENDER}}" != "" ]; then
        SENDER_ARG="--sender {{SENDER}}"
    fi
    
    # Load V4 infrastructure addresses if available
    export HOOK_ADDRESS=$HOOK_ADDRESS
    if [ -f {{pool-manager-file}} ]; then
        POOL_MGR=$(cat {{pool-manager-file}})
        export POOL_MANAGER_ADDRESS=$POOL_MGR
    fi
    if [ -f {{position-manager-file}} ]; then
        POS_MGR=$(cat {{position-manager-file}})
        export POSITION_MANAGER_ADDRESS=$POS_MGR
    fi
    if [ -f {{router-file}} ]; then
        ROUTER=$(cat {{router-file}})
        export ROUTER_ADDRESS=$ROUTER
    fi
    
    echo "Adding liquidity to pool with hook: $HOOK_ADDRESS"
    forge script script/02_AddLiquidity.s.sol \
        $RPC_ARG \
        $PRIVATE_KEY_ARG \
        $ACCOUNT_ARG \
        $SENDER_ARG \
        --broadcast

# ============================================================================
# Swap Commands
# ============================================================================

# Execute a regular swap
# Usage: just swap [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...] [HOOK_ADDRESS=]
swap RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" ACCOUNT='' SENDER='' HOOK_ADDRESS="":
    #!/usr/bin/env bash
    set -e
    
    # Load hook address from file if not provided
    if [ -z "{{HOOK_ADDRESS}}" ] && [ -f {{hook-address-file}} ]; then
        HOOK_ADDRESS=$(cat {{hook-address-file}})
        echo "Using hook address from file: $HOOK_ADDRESS"
    elif [ -z "{{HOOK_ADDRESS}}" ]; then
        echo "Error: HOOK_ADDRESS not set and not found in {{hook-address-file}}"
        echo "Please set HOOK_ADDRESS environment variable or run 'just deploy-hook' first"
        exit 1
    else
        HOOK_ADDRESS="{{HOOK_ADDRESS}}"
    fi
    
    RPC_ARG="--rpc-url {{RPC_URL}}"
    PRIVATE_KEY_ARG=""
    ACCOUNT_ARG=""
    SENDER_ARG=""
    
    # Use private key for local Anvil, or account for other networks
    PRIVATE_KEY_VAL="{{PRIVATE_KEY}}"
    if [ -n "$PRIVATE_KEY_VAL" ] && [ "$PRIVATE_KEY_VAL" != "" ]; then
        PRIVATE_KEY_ARG="--private-key $PRIVATE_KEY_VAL"
    fi
    
    # Only use --account if explicitly provided and not "default"
    if [ -n "{{ACCOUNT}}" ] && [ "{{ACCOUNT}}" != "default" ] && [ "{{ACCOUNT}}" != "" ]; then
        ACCOUNT_ARG="--account {{ACCOUNT}}"
    fi
    
    if [ -n "{{SENDER}}" ] && [ "{{SENDER}}" != "''" ] && [ "{{SENDER}}" != "" ]; then
        SENDER_ARG="--sender {{SENDER}}"
    fi
    
    # Load V4 infrastructure addresses if available
    export HOOK_ADDRESS=$HOOK_ADDRESS
    if [ -f {{pool-manager-file}} ]; then
        POOL_MGR=$(cat {{pool-manager-file}})
        export POOL_MANAGER_ADDRESS=$POOL_MGR
    fi
    if [ -f {{position-manager-file}} ]; then
        POS_MGR=$(cat {{position-manager-file}})
        export POSITION_MANAGER_ADDRESS=$POS_MGR
    fi
    if [ -f {{router-file}} ]; then
        ROUTER=$(cat {{router-file}})
        export ROUTER_ADDRESS=$ROUTER
    fi
    
    echo "Executing swap with hook: $HOOK_ADDRESS"
    forge script script/03_Swap.s.sol \
        $RPC_ARG \
        $PRIVATE_KEY_ARG \
        $ACCOUNT_ARG \
        $SENDER_ARG \
        --broadcast

# Execute a swap with commitment hash for RPS game
# Usage: just swap-rps COMMITMENT_HASH [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...] [HOOK_ADDRESS=]
swap-rps COMMITMENT_HASH RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" ACCOUNT='' SENDER='' HOOK_ADDRESS="":
    #!/usr/bin/env bash
    set -e
    
    if [ -z "{{COMMITMENT_HASH}}" ]; then
        echo "Error: COMMITMENT_HASH is required"
        echo "Usage: just swap-rps <COMMITMENT_HASH> [RPC_URL=...] [ACCOUNT=...] [SENDER=...] [HOOK_ADDRESS=]"
        exit 1
    fi
    
    # Load hook address from file if not provided
    if [ -z "{{HOOK_ADDRESS}}" ] && [ -f {{hook-address-file}} ]; then
        HOOK_ADDRESS=$(cat {{hook-address-file}})
        echo "Using hook address from file: $HOOK_ADDRESS"
    elif [ -z "{{HOOK_ADDRESS}}" ]; then
        echo "Error: HOOK_ADDRESS not set and not found in {{hook-address-file}}"
        echo "Please set HOOK_ADDRESS environment variable or run 'just deploy-hook' first"
        exit 1
    else
        HOOK_ADDRESS="{{HOOK_ADDRESS}}"
    fi
    
    RPC_ARG="--rpc-url {{RPC_URL}}"
    PRIVATE_KEY_ARG=""
    ACCOUNT_ARG=""
    SENDER_ARG=""
    
    # Use private key for local Anvil
    PRIVATE_KEY_VAL="{{PRIVATE_KEY}}"
    if [ -n "$PRIVATE_KEY_VAL" ] && [ "$PRIVATE_KEY_VAL" != "" ]; then
        PRIVATE_KEY_ARG="--private-key"
        PRIVATE_KEY_VALUE="$PRIVATE_KEY_VAL"
    else
        PRIVATE_KEY_ARG=""
        PRIVATE_KEY_VALUE=""
    fi
    
    # Only use --account if explicitly provided
    ACCOUNT_VAL="{{ACCOUNT}}"
    if [ -n "$ACCOUNT_VAL" ] && [ "$ACCOUNT_VAL" != "default" ] && [ "$ACCOUNT_VAL" != "" ]; then
        ACCOUNT_ARG="--account"
        ACCOUNT_VALUE="$ACCOUNT_VAL"
    else
        ACCOUNT_ARG=""
        ACCOUNT_VALUE=""
    fi
    
    SENDER_VAL="{{SENDER}}"
    if [ -n "$SENDER_VAL" ] && [ "$SENDER_VAL" != "''" ] && [ "$SENDER_VAL" != "" ]; then
        SENDER_ARG="--sender"
        SENDER_VALUE="$SENDER_VAL"
    else
        SENDER_ARG=""
        SENDER_VALUE=""
    fi
    
    # Load V4 infrastructure addresses if available
    export HOOK_ADDRESS=$HOOK_ADDRESS
    export COMMITMENT_HASH={{COMMITMENT_HASH}}
    if [ -f {{pool-manager-file}} ]; then
        POOL_MGR=$(cat {{pool-manager-file}})
        export POOL_MANAGER_ADDRESS=$POOL_MGR
    fi
    if [ -f {{position-manager-file}} ]; then
        POS_MGR=$(cat {{position-manager-file}})
        export POSITION_MANAGER_ADDRESS=$POS_MGR
    fi
    if [ -f {{router-file}} ]; then
        ROUTER=$(cat {{router-file}})
        export ROUTER_ADDRESS=$ROUTER
    fi
    
    echo "Executing RPS swap with commitment: {{COMMITMENT_HASH}}"
    echo "Hook address: $HOOK_ADDRESS"
    # Build command array to avoid empty argument issues
    CMD_ARGS=("script/03_Swap.s.sol" $RPC_ARG)
    [ -n "$PRIVATE_KEY_ARG" ] && CMD_ARGS+=($PRIVATE_KEY_ARG "$PRIVATE_KEY_VALUE")
    [ -n "$ACCOUNT_ARG" ] && CMD_ARGS+=($ACCOUNT_ARG "$ACCOUNT_VALUE")
    [ -n "$SENDER_ARG" ] && CMD_ARGS+=($SENDER_ARG "$SENDER_VALUE")
    CMD_ARGS+=(--broadcast)
    
    forge script "${CMD_ARGS[@]}"

# ============================================================================
# Development & Testing Commands
# ============================================================================

# Run all tests
test:
    forge test

# Run tests with verbosity
test-verbose:
    forge test -vvv

# Run specific test file
test-file FILE:
    forge test --match-path {{FILE}}

# Build the project
build:
    forge build

# Clean build artifacts
clean:
    forge clean

# Format code
fmt:
    forge fmt

# ============================================================================
# Complete Workflow Commands
# ============================================================================

# Complete setup: deploy V4 infrastructure, tokens, hook, create pool, and add initial liquidity
# Usage: just setup [RPC_URL=http://localhost:8545] [PRIVATE_KEY=0x...]
setup RPC_URL="http://localhost:8545" PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80" ACCOUNT='' SENDER='':
    #!/usr/bin/env bash
    set -e
    
    # All recipes use default values, so we can call them without arguments
    # The defaults are set in each recipe signature
    echo "=== Step 1: Deploying Tokens ==="
    just deploy-tokens
    
    echo ""
    echo "=== Step 2: Deploying V4 Infrastructure ==="
    just deploy-v4
    
    echo ""
    echo "=== Step 3: Deploying Hook ==="
    just deploy-hook
    
    echo ""
    echo "=== Step 4: Creating Pool and Adding Liquidity ==="
    if [ -f .hook_address ]; then
        HOOK_ADDR=$(cat .hook_address)
        # Export HOOK_ADDRESS as environment variable instead of passing as argument
        export HOOK_ADDRESS="$HOOK_ADDR"
        just create-pool
    else
        echo "Error: Hook address file not found. Make sure deploy-hook completed successfully."
        exit 1
    fi
    
    echo ""
    echo "✓ Setup complete!"
    echo "Hook address: $HOOK_ADDR"
    echo "You can now run swaps with: just swap"

# ============================================================================
# Utility Commands
# ============================================================================

# Show current configuration
status:
    #!/usr/bin/env bash
    echo "=== Current Configuration ==="
    echo ""
    
    if [ -f {{hook-address-file}} ]; then
        HOOK_ADDR=$(cat {{hook-address-file}})
        echo "Hook Address: $HOOK_ADDR"
    else
        echo "Hook Address: Not set"
    fi
    
    echo ""
    echo "Default RPC URL: {{default-rpc-url}}"
    echo "Default Account: {{default-account}}"
    echo ""
    echo "To override defaults, use environment variables:"
    echo "  export RPC_URL=<your-rpc-url>"
    echo "  export ACCOUNT=<your-account-name>"
    echo "  export SENDER=<your-sender-address>"
    echo "  export HOOK_ADDRESS=<hook-address>"

# Clear saved hook address
clear-hook:
    rm -f {{hook-address-file}}
    echo "Cleared saved hook address"
