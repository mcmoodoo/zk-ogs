# Justfile for DegenRPS deployment and development

# Default RPC URL
default-rpc-url := "http://localhost:8545"

# Default private key for local Anvil
default-private-key := "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"

# Chain ID (defaults to local Anvil)
chain-id := "31337"

# Deployments JSON file path
deployments-file := "../frontend/deployments.json"

# Default recipe - show available commands
default:
    @just --list

# ============================================================================
# Helper Functions
# ============================================================================

# Extract address from broadcast JSON file
# Usage: just _extract-from-broadcast <script-name> <contract-name>
_extract-from-broadcast SCRIPT_NAME CONTRACT_NAME:
    #!/usr/bin/env bash
    BROADCAST_FILE="broadcast/{{SCRIPT_NAME}}/{{chain-id}}/run-latest.json"
    if [ -f "$BROADCAST_FILE" ]; then
        jq -r ".transactions[] | select(.contractName == \"{{CONTRACT_NAME}}\") | .contractAddress" "$BROADCAST_FILE" 2>/dev/null | head -1
    fi

# Set contract metadata in deployments.json
# Usage: just _set-contract-metadata <key> <address> <abi-path> <block-number>
_set-contract-metadata KEY ADDRESS ABI_PATH BLOCK_NUMBER:
    #!/usr/bin/env bash
    if [ ! -f {{deployments-file}} ]; then
        echo '{"chainId": "{{chain-id}}", "rpcUrl": "{{default-rpc-url}}", "contracts": {}}' > {{deployments-file}}
    fi
    
    # Ensure chainId, rpcUrl and contracts structure exists
    jq '.chainId = "{{chain-id}}" | .rpcUrl = (.rpcUrl // "{{default-rpc-url}}") | .contracts = (.contracts // {})' {{deployments-file}} > {{deployments-file}}.tmp && mv {{deployments-file}}.tmp {{deployments-file}}
    
    # Read ABI if file exists and is not empty
    ABI="[]"
    if [ -n "{{ABI_PATH}}" ] && [ "{{ABI_PATH}}" != "" ] && [ -f "{{ABI_PATH}}" ]; then
        ABI=$(jq -c '.abi' "{{ABI_PATH}}" 2>/dev/null || echo "[]")
    fi
    
    # Update deployments.json with contract info
    jq --arg key "{{KEY}}" \
       --arg addr "{{ADDRESS}}" \
       --argjson abi "$ABI" \
       --arg block "{{BLOCK_NUMBER}}" \
       '.contracts[$key] = {
         address: $addr,
         abi: $abi,
         blockNumber: ($block | tonumber)
       }' {{deployments-file}} > {{deployments-file}}.tmp && mv {{deployments-file}}.tmp {{deployments-file}}

# Get address from deployments.json
# Usage: just _get-address <key>
_get-address KEY:
    #!/usr/bin/env bash
    if [ -f {{deployments-file}} ]; then
        jq -r ".contracts[\"{{KEY}}\"].address // empty" {{deployments-file}} 2>/dev/null || echo ""
    fi

# ============================================================================
# Setup & Build
# ============================================================================

# Check if Anvil is running
check-anvil:
    @echo "Checking if Anvil is running..."
    @curl -s {{default-rpc-url}} > /dev/null 2>&1 || (echo "‚ùå Anvil is not running on {{default-rpc-url}}" && echo "   Start it with: anvil" && exit 1)
    @echo "‚úÖ Anvil is running"

# Build contracts
build:
    @echo "üì¶ Building contracts..."
    forge build --force
    @echo "‚úÖ Build complete"

# Clean build artifacts
clean:
    @echo "üßπ Cleaning build artifacts..."
    forge clean
    @echo "‚úÖ Clean complete"

# ============================================================================
# Deployment
# ============================================================================

# Deploy all contracts to local Anvil
# This deploys: Verifier, DegenRPS, Token0, Token1
# Automatically extracts addresses and updates deployments.json
deploy:
    #!/usr/bin/env bash
    set -e
    
    just check-anvil
    just build
    
    echo "üöÄ Deploying contracts to Anvil..."
    echo ""
    
    # Deploy contracts (set PRIVATE_KEY env var for the script)
    export PRIVATE_KEY={{default-private-key}}
    forge script script/Deploy.s.sol:DeployScript \
        --rpc-url {{default-rpc-url}} \
        --broadcast \
        --private-key {{default-private-key}}
    
    echo ""
    echo "üìã Extracting contract addresses from broadcast files..."
    
    # Extract addresses from broadcast JSON
    BROADCAST_FILE="broadcast/Deploy.s.sol/{{chain-id}}/run-latest.json"
    
    if [ ! -f "$BROADCAST_FILE" ]; then
        echo "‚ùå Error: Broadcast file not found: $BROADCAST_FILE"
        exit 1
    fi
    
    # Extract addresses - get all CREATE transactions first
    # Verifier
    VERIFIER_ADDR=$(jq -r '.transactions[] | select(.contractName == "HonkVerifier" and (.transactionType == "CREATE" or .transactionType == "CREATE2")) | .contractAddress' "$BROADCAST_FILE" 2>/dev/null | head -1)
    
    # DegenRPS
    DEGEN_RPS_ADDR=$(jq -r '.transactions[] | select(.contractName == "DegenRPS" and (.transactionType == "CREATE" or .transactionType == "CREATE2")) | .contractAddress' "$BROADCAST_FILE" 2>/dev/null | head -1)
    
    # Tokens - get all MockERC20 CREATE transactions
    TOKEN_ADDRS=($(jq -r '.transactions[] | select(.contractName == "MockERC20" and (.transactionType == "CREATE" or .transactionType == "CREATE2")) | .contractAddress' "$BROADCAST_FILE" 2>/dev/null))
    TOKEN0_ADDR="${TOKEN_ADDRS[0]}"
    TOKEN1_ADDR="${TOKEN_ADDRS[1]}"
    
    # Get block numbers
    VERIFIER_BLOCK=$(jq -r --arg addr "$VERIFIER_ADDR" '.receipts[] | select(.contractAddress == $addr) | .blockNumber' "$BROADCAST_FILE" 2>/dev/null | head -1 || echo "0")
    DEGEN_RPS_BLOCK=$(jq -r --arg addr "$DEGEN_RPS_ADDR" '.receipts[] | select(.contractAddress == $addr) | .blockNumber' "$BROADCAST_FILE" 2>/dev/null | head -1 || echo "0")
    TOKEN0_BLOCK=$(jq -r --arg addr "$TOKEN0_ADDR" '.receipts[] | select(.contractAddress == $addr) | .blockNumber' "$BROADCAST_FILE" 2>/dev/null | head -1 || echo "0")
    TOKEN1_BLOCK=$(jq -r --arg addr "$TOKEN1_ADDR" '.receipts[] | select(.contractAddress == $addr) | .blockNumber' "$BROADCAST_FILE" 2>/dev/null | head -1 || echo "0")
    
    # Convert hex to decimal
    VERIFIER_BLOCK=$(printf "%d" "$VERIFIER_BLOCK" 2>/dev/null || echo "0")
    DEGEN_RPS_BLOCK=$(printf "%d" "$DEGEN_RPS_BLOCK" 2>/dev/null || echo "0")
    TOKEN0_BLOCK=$(printf "%d" "$TOKEN0_BLOCK" 2>/dev/null || echo "0")
    TOKEN1_BLOCK=$(printf "%d" "$TOKEN1_BLOCK" 2>/dev/null || echo "0")
    
    if [ -z "$VERIFIER_ADDR" ] || [ -z "$DEGEN_RPS_ADDR" ] || [ -z "$TOKEN0_ADDR" ] || [ -z "$TOKEN1_ADDR" ]; then
        echo "‚ùå Error: Could not extract all contract addresses"
        echo "   Verifier: $VERIFIER_ADDR"
        echo "   DegenRPS: $DEGEN_RPS_ADDR"
        echo "   Token0: $TOKEN0_ADDR"
        echo "   Token1: $TOKEN1_ADDR"
        exit 1
    fi
    
    echo "‚úÖ Extracted addresses:"
    echo "   Verifier:  $VERIFIER_ADDR"
    echo "   DegenRPS:  $DEGEN_RPS_ADDR"
    echo "   Token0:    $TOKEN0_ADDR"
    echo "   Token1:    $TOKEN1_ADDR"
    echo ""
    
    # Update deployments.json with addresses and ABIs
    echo "üìù Updating frontend/deployments.json..."
    
    # Save Verifier (ABI from compiled contract)
    just _set-contract-metadata verifier "$VERIFIER_ADDR" "out/Verifier.sol/HonkVerifier.json" "$VERIFIER_BLOCK"
    
    # Save DegenRPS (ABI from compiled contract)
    just _set-contract-metadata degenRPS "$DEGEN_RPS_ADDR" "out/DegenRPS.sol/DegenRPS.json" "$DEGEN_RPS_BLOCK"
    
    # Save Token0 (ABI from compiled contract - MockERC20)
    just _set-contract-metadata token0 "$TOKEN0_ADDR" "out/MockERC20.sol/MockERC20.json" "$TOKEN0_BLOCK"
    
    # Save Token1 (ABI from compiled contract - MockERC20)
    just _set-contract-metadata token1 "$TOKEN1_ADDR" "out/MockERC20.sol/MockERC20.json" "$TOKEN1_BLOCK"
    
    echo ""
    echo "‚úÖ Deployment complete! Addresses saved to {{deployments-file}}"
    echo ""
    echo "üìã Deployed contracts:"
    echo "   Verifier:  $VERIFIER_ADDR"
    echo "   DegenRPS:  $DEGEN_RPS_ADDR"
    echo "   Token0:    $TOKEN0_ADDR"
    echo "   Token1:    $TOKEN1_ADDR"
    echo ""
    
    # Setup test wallets (fund with ETH and mint tokens)
    echo ""
    echo "üí∞ Setting up test wallets..."
    MAKER="0x2f04d60991191005103d73bdcf12187a824d42a4"
    TAKER="0x3109f6462af03c604b36664b511a17814ee8acff"
    
    echo "   Funding Maker wallet ($MAKER)..."
    cast send "$MAKER" \
        --value 100ether \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}} > /dev/null 2>&1 || echo "   ‚ö†Ô∏è Failed to fund Maker wallet"
    
    echo "   Funding Taker wallet ($TAKER)..."
    cast send "$TAKER" \
        --value 100ether \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}} > /dev/null 2>&1 || echo "   ‚ö†Ô∏è Failed to fund Taker wallet"
    
    echo "   Minting 1000 Token0 to Maker..."
    cast send "$TOKEN0_ADDR" \
        "mint(address,uint256)" "$MAKER" 1000e18 \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}} > /dev/null 2>&1 || echo "   ‚ö†Ô∏è Failed to mint Token0 to Maker"
    
    echo "   Minting 1000 Token0 to Taker..."
    cast send "$TOKEN0_ADDR" \
        "mint(address,uint256)" "$TAKER" 1000e18 \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}} > /dev/null 2>&1 || echo "   ‚ö†Ô∏è Failed to mint Token0 to Taker"
    
    echo "   Minting 1000 Token1 to Maker..."
    cast send "$TOKEN1_ADDR" \
        "mint(address,uint256)" "$MAKER" 1000e18 \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}} > /dev/null 2>&1 || echo "   ‚ö†Ô∏è Failed to mint Token1 to Maker"
    
    echo "   Minting 1000 Token1 to Taker..."
    cast send "$TOKEN1_ADDR" \
        "mint(address,uint256)" "$TAKER" 1000e18 \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}} > /dev/null 2>&1 || echo "   ‚ö†Ô∏è Failed to mint Token1 to Taker"
    
    echo ""
    echo "‚úÖ Test wallets setup complete!"
    echo ""
    echo "üí° Test Accounts:"
    echo "   Maker: $MAKER"
    echo "     - 100 ETH"
    echo "     - 1000 Token0"
    echo "     - 1000 Token1"
    echo ""
    echo "   Taker: $TAKER"
    echo "     - 100 ETH"
    echo "     - 1000 Token0"
    echo "     - 1000 Token1"
    echo ""
    echo "üí° Default deployer account (has 1M test tokens):"
    echo "   Address: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
    echo "   Private Key: {{default-private-key}}"

# Show all deployed addresses
show-addresses:
    #!/usr/bin/env bash
    if [ -f {{deployments-file}} ]; then
        echo "=== Deployed Contract Addresses ==="
        echo ""
        cat {{deployments-file}} | jq '.contracts | to_entries | map({key: .key, address: .value.address}) | from_entries'
    else
        echo "No deployments found. Run 'just deploy' first."
    fi

# ============================================================================
# Testing
# ============================================================================

# Run tests
test:
    @echo "üß™ Running tests..."
    forge test

# Run tests with verbose output
test-verbose:
    @echo "üß™ Running tests with verbose output..."
    forge test -vvv

# Run a specific test
test-match pattern:
    @echo "üß™ Running tests matching: {{pattern}}"
    forge test --match-test {{pattern}}

# ============================================================================
# Anvil Management
# ============================================================================

# Start Anvil in the background
anvil-start:
    @echo "üöÄ Starting Anvil..."
    @anvil > /tmp/anvil.log 2>&1 &
    @echo "‚úÖ Anvil started"
    @echo "   Logs: /tmp/anvil.log"
    @echo "   Stop with: just anvil-stop"

# Stop Anvil
anvil-stop:
    @echo "üõë Stopping Anvil..."
    @pkill -f "anvil" || echo "Anvil not running"
    @echo "‚úÖ Anvil stopped"

# Show Anvil logs
anvil-logs:
    @tail -f /tmp/anvil.log

# ============================================================================
# Query Commands
# ============================================================================

# Get next game ID
next-game-id:
    #!/usr/bin/env bash
    DEGEN_RPS_ADDR=$(just _get-address degenRPS)
    if [ -z "$DEGEN_RPS_ADDR" ]; then
        echo "‚ùå DegenRPS address not found. Run 'just deploy' first."
        exit 1
    fi
    echo "üìã Next game ID:"
    cast call "$DEGEN_RPS_ADDR" "nextGameId()" --rpc-url {{default-rpc-url}}

# Get game info
# Usage: just get-game <game_id>
get-game game_id:
    #!/usr/bin/env bash
    DEGEN_RPS_ADDR=$(just _get-address degenRPS)
    if [ -z "$DEGEN_RPS_ADDR" ]; then
        echo "‚ùå DegenRPS address not found. Run 'just deploy' first."
        exit 1
    fi
    echo "üìã Game {{game_id}} info:"
    cast call "$DEGEN_RPS_ADDR" "getGame(uint256)" {{game_id}} --rpc-url {{default-rpc-url}}

# Get games waiting for Player 2
games-waiting:
    #!/usr/bin/env bash
    DEGEN_RPS_ADDR=$(just _get-address degenRPS)
    if [ -z "$DEGEN_RPS_ADDR" ]; then
        echo "‚ùå DegenRPS address not found. Run 'just deploy' first."
        exit 1
    fi
    echo "üìã Games waiting for Player 2:"
    cast call "$DEGEN_RPS_ADDR" "getGamesWaitingForPlayer2()" --rpc-url {{default-rpc-url}}

# Get token balance
# Usage: just balance <token_addr> <account>
balance token_addr account:
    @echo "üí∞ Balance of {{account}} in token {{token_addr}}:"
    @cast call {{token_addr}} "balanceOf(address)" {{account}} --rpc-url {{default-rpc-url}}

# ============================================================================
# Utility Commands
# ============================================================================

# ============================================================================
# Token & Wallet Management
# ============================================================================

# Mint tokens to an address
# Usage: just mint-tokens <token_address> <recipient> <amount>
mint-tokens token_address recipient amount:
    #!/usr/bin/env bash
    set -e
    
    TOKEN_ADDR="{{token_address}}"
    RECIPIENT="{{recipient}}"
    AMOUNT="{{amount}}"
    
    echo "üí∞ Minting {{amount}} tokens to {{recipient}}..."
    cast send "$TOKEN_ADDR" \
        "mint(address,uint256)" "$RECIPIENT" "$AMOUNT" \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}}
    
    echo "‚úÖ Minted {{amount}} tokens to {{recipient}}"

# Fund an address with ETH
# Usage: just fund-eth <recipient> <amount_in_ether>
fund-eth recipient amount_in_ether:
    #!/usr/bin/env bash
    set -e
    
    RECIPIENT="{{recipient}}"
    AMOUNT="{{amount_in_ether}}"
    
    echo "üí∞ Funding {{recipient}} with {{amount_in_ether}} ETH..."
    cast send "$RECIPIENT" \
        --value {{amount_in_ether}}ether \
        --private-key {{default-private-key}} \
        --rpc-url {{default-rpc-url}}
    
    echo "‚úÖ Funded {{recipient}} with {{amount_in_ether}} ETH"

# Setup test wallets: mint tokens and fund with ETH
# This sets up the default maker and taker wallets for testing
setup-test-wallets:
    #!/usr/bin/env bash
    set -e
    
    MAKER="0x2f04d60991191005103d73bdcf12187a824d42a4"
    TAKER="0x3109f6462af03c604b36664b511a17814ee8acff"
    
    # Get token addresses from deployments.json
    TOKEN0=$(just _get-address token0)
    TOKEN1=$(just _get-address token1)
    
    if [ -z "$TOKEN0" ] || [ -z "$TOKEN1" ]; then
        echo "‚ùå Error: Token addresses not found. Run 'just deploy' first."
        exit 1
    fi
    
    echo "üöÄ Setting up test wallets..."
    echo ""
    echo "Maker wallet: $MAKER"
    echo "Taker wallet: $TAKER"
    echo ""
    
    # Fund with ETH
    echo "üì¶ Funding wallets with ETH..."
    just fund-eth "$MAKER" 100
    just fund-eth "$TAKER" 100
    echo ""
    
    # Mint tokens (1000 tokens with 18 decimals = 1000e18)
    echo "ü™ô Minting tokens..."
    just mint-tokens "$TOKEN0" "$MAKER" 1000e18
    just mint-tokens "$TOKEN0" "$TAKER" 1000e18
    just mint-tokens "$TOKEN1" "$MAKER" 1000e18
    just mint-tokens "$TOKEN1" "$TAKER" 1000e18
    echo ""
    
    echo "‚úÖ Test wallets setup complete!"
    echo ""
    echo "Maker wallet ($MAKER):"
    echo "  - 100 ETH"
    echo "  - 1000 Token0"
    echo "  - 1000 Token1"
    echo ""
    echo "Taker wallet ($TAKER):"
    echo "  - 100 ETH"
    echo "  - 1000 Token0"
    echo "  - 1000 Token1"

# Mint tokens to maker wallet
# Usage: just mint-maker <token_address> <amount>
mint-maker token_address amount:
    @just mint-tokens {{token_address}} 0x2f04d60991191005103d73bdcf12187a824d42a4 {{amount}}

# Mint tokens to taker wallet
# Usage: just mint-taker <token_address> <amount>
mint-taker token_address amount:
    @just mint-tokens {{token_address}} 0x3109f6462af03c604b36664b511a17814ee8acff {{amount}}

# Fund maker wallet with ETH
# Usage: just fund-maker <amount_in_ether>
fund-maker amount_in_ether:
    @just fund-eth 0x2f04d60991191005103d73bdcf12187a824d42a4 {{amount_in_ether}}

# Fund taker wallet with ETH
# Usage: just fund-taker <amount_in_ether>
fund-taker amount_in_ether:
    @just fund-eth 0x3109f6462af03c604b36664b511a17814ee8acff {{amount_in_ether}}

# ============================================================================
# Summary & Status
# ============================================================================

# Show deployment summary
summary:
    #!/usr/bin/env bash
    echo "üìã DegenRPS Deployment Summary"
    echo "=============================="
    echo ""
    echo "Anvil Status:"
    if curl -s {{default-rpc-url}} > /dev/null 2>&1; then
        echo "  ‚úÖ Running"
    else
        echo "  ‚ùå Not running"
    fi
    echo ""
    echo "Contracts Built:"
    [ -f out/DegenRPS.sol/DegenRPS.json ] && echo "  ‚úÖ DegenRPS" || echo "  ‚ùå DegenRPS"
    [ -f out/Verifier.sol/HonkVerifier.json ] && echo "  ‚úÖ Verifier" || echo "  ‚ùå Verifier"
    echo ""
    echo "Deployed Contracts:"
    if [ -f {{deployments-file}} ]; then
        VERIFIER=$(just _get-address verifier)
        DEGEN_RPS=$(just _get-address degenRPS)
        TOKEN0=$(just _get-address token0)
        TOKEN1=$(just _get-address token1)
        [ -n "$VERIFIER" ] && echo "  ‚úÖ Verifier: $VERIFIER" || echo "  ‚ùå Verifier: Not deployed"
        [ -n "$DEGEN_RPS" ] && echo "  ‚úÖ DegenRPS: $DEGEN_RPS" || echo "  ‚ùå DegenRPS: Not deployed"
        [ -n "$TOKEN0" ] && echo "  ‚úÖ Token0: $TOKEN0" || echo "  ‚ùå Token0: Not deployed"
        [ -n "$TOKEN1" ] && echo "  ‚úÖ Token1: $TOKEN1" || echo "  ‚ùå Token1: Not deployed"
    else
        echo "  ‚ùå No deployments found"
    fi
    echo ""
    echo "Frontend Config:"
    [ -f {{deployments-file}} ] && echo "  ‚úÖ deployments.json exists" || echo "  ‚ùå deployments.json missing"

# Full deployment workflow: start anvil, deploy, show summary
deploy-full:
    @echo "üöÄ Full deployment workflow..."
    @just anvil-start || true
    @sleep 2
    @just deploy
    @echo ""
    @just summary
